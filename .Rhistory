install.packages("haven") # Archivos .dta
install.packages("haven") # Archivos .dta
install.packages("plm")
install.packages("skimr")
install.packages("skimr")
install.packages("dplyr")
install.packages("ggplot2")
install.packages("skimr")
install.packages("skimr")
# Leer archivo .dta
data <- read_dta("oil_windfall_sin10perc.dta")
library(haven)
library(haven)
library(plm)
library(haven)
library(plm)
library(scales)
library(skimr)
library(haven)
library(plm)
library(scales)
library(skimr)
library(dplyr)
library(ggplot2)
# Leer archivo .dta
data <- read_dta("oil_windfall_sin10perc.dta")
getwd()
list.files()
file.exists("oil_windfall_sin10perc.dta")
# Leer archivo .dta
data <- read_dta("oil_windfall_sin10perc.dta")
# Leer archivo .dta
data <- read_dta("oil_windfall_sin10perc.dta")
View(data)
set.seed(201613424)
# Cargar liberias y paquetes
install.packages("haven") # Archivos .dta
install.packages("plm")
install.packages("skimr")
install.packages("dplyr")
install.packages("ggplot2")
library(haven)
library(plm)
library(scales)
library(skimr)
library(dplyr)
library(ggplot2)
# Leer archivo .dta
data <- read_dta("oil_windfall_sin10perc.dta")
set.seed(201613424)
install.packages("skimr")
rmarkdown::render("Taller_2_LauraRivera_CamilaCaraballo.Rmd")
library(AER)
library(fixest)
library(lmtest)
library(sandwich)
library(tidyverse)
library(stargazer)
# Leer archivo .dta
data <- read_dta("oil_windfall_sin10perc.dta")
set.seed(201613424)
# Número exacto de filas a eliminar (10% de la base)
eliminar <- round(0.1 * nrow(data))
# Escoger aleatoriamente los índices a eliminar
drop_index <- sample(1:nrow(data), size = eliminar)
# Crear la submuestra eliminando esos índices
data_final <- data[-drop_index, ]
# Solo municipios costeros que reciben petroleo
data_final <- subset(data_final, coastal == 1 & onshore == 0)
#Transformación de variables
data_final <- data_final %>%
rename(
revenue     = mun_budget_revenue2000_pred_c,
oil_pc      = oilandgasvalue2000_cap,
lat         = latitude1998,
lon         = longitude1998,
coast       = coastal,
dist_fedcap = dist_federal_capital1998,
dist_statecap = dist_state_capital1998,
state_cap   = state_capital,
state    = sigla
)
# Cambiar a tipo factor
data_final <- data_final %>% mutate(state = as.factor(state))
# Primera etapa con FE de estado
prim_et <- lm(
revenue ~ oil_pc + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state),
data = data_final
)
vc <- vcovCL(primer, cluster = ~ state, type = "HC1")
#Resultados por cluster
vc <- vcovCL(prim_et, cluster = ~ state, type = "HC1")
ct <- coeftest(prim_et, vcov = vc)
# Solo coeficientes a reportar y sus SE
vars_keep <- c("oil_pc","lat","lon","coast","dist_fedcap","dist_statecap","state_cap")
idx <- match(vars_keep, rownames(ct))
betas <- ct[idx, "Estimate"]
ses   <- ct[idx, "Std. Error"]
#Tabulación de los resultados
stargazer(
primer,
type = "text",
coef = list(betas),
se   = list(ses),
keep = paste0("^(", paste(vars_keep, collapse="|"), ")$"),
dep.var.labels   = "Ingresos municipales",
covariate.labels = c("Producción de petróleo","Latitud","Longitud",
"Dummy costa","Dist. capital federal","Dist. capital estatal","Dummy capital estatal"),
omit             = "factor\\(state_id\\)|\\(Intercept\\)",
star.cutoffs     = c(.10,.05,.01),
digits           = 3,
title            = "Primera etapa: ingresos municipales sobre producción petrolera y controles"
)
#Tabulación de los resultados
stargazer(
prim_et,
type = "text",
coef = list(betas),
se   = list(ses),
keep = paste0("^(", paste(vars_keep, collapse="|"), ")$"),
dep.var.labels   = "Ingresos municipales",
covariate.labels = c("Producción de petróleo","Latitud","Longitud",
"Dummy costa","Dist. capital federal","Dist. capital estatal","Dummy capital estatal"),
omit             = "factor\\(state_id\\)|\\(Intercept\\)",
star.cutoffs     = c(.10,.05,.01),
digits           = 3,
title            = "Primera etapa: ingresos municipales sobre producción petrolera y controles"
)
View(data_final)
names(data_final)
sapply(data_final, function(x) attr(x, "label"))
data_final <- data_final %>%
rename(
amc_code        = new_code_1970_1997,
per_ho_elec     = prc_hhld_with_power_2000,
salon_pob_2005  = clroomsMunicipal_pop2005,
clinic_pob_2002 = estab_mun2002_without_pop,
km_pob_2005     = km_paved_munic_c,
ex_edu_cult        = pmun_exp_funct_educ_cult2000c,
ex_salud_sani      = pmun_exp_funct_health_sanit2000c,
ex_desarrollo_urb  = pmun_exp_funct_hous_urban2000c,
ex_transp          = pmun_exp_funct_transport2000c,
ex_soc_transf      = pmun_exp_funct_welf2000c,
perc_nofavelas     = p_hhld_abovestrandard_ppl_2000
)
names(data_final)
#Agrupación de variables de interés
outcomes <- c(
"ex_edu_cult",
"ex_salud_sani",
"ex_desarrollo_urb",
"ex_transp", "
ex_soc_transf"
)
#Agrupación de controles
controls <- ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap
etable(
fml = list(
ex_edu_cult       ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state | (revenue ~ oil_pc),
ex_salud_sani     ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state | (revenue ~ oil_pc),
ex_desarrollo_urb ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state | (revenue ~ oil_pc),
ex_transp         ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state | (revenue ~ oil_pc),
ex_soc_transf     ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state | (revenue ~ oil_pc)
),
data    = df,
cluster = ~ state,        # errores agrupados por estado
se      = "cluster",
dict    = c(
"revenue" = "Ingresos (IV)",
"oil_pc"  = "Petróleo pc (instrumento)",
"lat" = "Latitud", "lon" = "Longitud", "coast" = "Costa",
"dist_fedcap" = "Dist. capital federal", "dist_statecap" = "Dist. capital estatal",
"state_cap" = "Capital estatal"
),
title   = "Segunda etapa (IV): ingresos municipales instrumentados y gastos por función"
)
etable(
fml = list(
ex_edu_cult       ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state | (revenue ~ oil_pc),
ex_salud_sani     ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state | (revenue ~ oil_pc),
ex_desarrollo_urb ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state | (revenue ~ oil_pc),
ex_transp         ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state | (revenue ~ oil_pc),
ex_soc_transf     ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state | (revenue ~ oil_pc)
),
data    = data_final,
cluster = ~ state,        # errores agrupados por estado
se      = "cluster",
dict    = c(
"revenue" = "Ingresos (IV)",
"oil_pc"  = "Petróleo pc (instrumento)",
"lat" = "Latitud", "lon" = "Longitud", "coast" = "Costa",
"dist_fedcap" = "Dist. capital federal", "dist_statecap" = "Dist. capital estatal",
"state_cap" = "Capital estatal"
),
title   = "Segunda etapa (IV): ingresos municipales instrumentados y gastos por función"
)
seg_et <- feols(
fml = list(
ex_edu_cult       ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state,
ex_salud_sani     ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state,
ex_desarrollo_urb ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state,
ex_transp         ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state,
ex_soc_transf     ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state
),
data    = df,
iv      = ~ revenue ~ oil_pc,  # instrumenta 'revenue' con 'oil_pc'
cluster = ~ state              # errores agrupados por estado
)
seg_et <- feols(
fml = list(
ex_edu_cult       ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state,
ex_salud_sani     ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state,
ex_desarrollo_urb ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state,
ex_transp         ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state,
ex_soc_transf     ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state
),
data    = data_final,
iv      = ~ revenue ~ oil_pc,  # instrumenta 'revenue' con 'oil_pc'
cluster = ~ state              # errores agrupados por estado
)
seg_et <- feols(
fml = list(
ex_edu_cult       ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state,
ex_salud_sani     ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state,
ex_desarrollo_urb ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state,
ex_transp         ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state,
ex_soc_transf     ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state
),
data    = data_final,
iv      = ~ revenue ~ oil_pc,  # instrumenta 'revenue' con 'oil_pc'
cluster = ~ state              # errores agrupados por estado
)
library(fixest)
library(lmtest)
library(sandwich)
library(stargazer)
seg_et <- feols(
fml = list(
ex_edu_cult       ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state,
ex_salud_sani     ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state,
ex_desarrollo_urb ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state,
ex_transp         ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state,
ex_soc_transf     ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state
),
data    = data_final,
iv      = ~ revenue ~ oil_pc,  # instrumenta 'revenue' con 'oil_pc'
cluster = ~ state              # errores agrupados por estado
)
data_final$state <- as.factor(data_final$state)
# Segunda etapa IV — modelos individuales
m_edu <- feols(
ex_edu_cult ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state | (revenue ~ oil_pc),
data = data_final, cluster = ~ state
)
stopifnot(all(c(
"ex_edu_cult","ex_salud_sani","ex_desarrollo_urb","ex_transp","ex_soc_transf",
"revenue","oil_pc","lat","lon","coast","dist_fedcap","dist_statecap","state_cap","state"
) %in% names(data_final)))
num_vars <- c("revenue","oil_pc","lat","lon","coast","dist_fedcap","dist_statecap","state_cap",
"ex_edu_cult","ex_salud_sani","ex_desarrollo_urb","ex_transp","ex_soc_transf")
data_final <- data_final %>%
mutate(across(all_of(num_vars), ~ suppressWarnings(as.numeric(.)))) %>%
mutate(state = as.factor(state))
# Segunda etapa IV — modelos individuales
m_edu <- feols(
ex_edu_cult ~ lat + lon + coast + dist_fedcap + dist_statecap + state_cap | state | (revenue ~ oil_pc),
data = data_final, cluster = ~ state
)
m_edu_iv   <- ivreg(ex_edu_cult       ~ revenue + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state) |
oil_pc + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state), data = df)
m_edu_iv <- ivreg(ex_edu_cult ~ revenue + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state) | oil_pc + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state), data = data_final)
m_salud_iv <- ivreg(ex_salud_sani ~ revenue + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state) |oil_pc + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state), data = data_final)
m_urb_iv  <- ivreg(ex_desarrollo_urb ~ revenue + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state) |oil_pc + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state), data = data_final)
m_trans_iv <- ivreg(ex_transp ~ revenue + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state) |oil_pc + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state), data = data_final)
m_soc_iv   <- ivreg(ex_soc_transf     ~ revenue + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state) |oil_pc + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state), data = data_final)
#Errores agrupados por Estado
vc <- function(m) sandwich::vcovCL(m, cluster = ~ state, type = "HC1")
ses <- lapply(list(m_edu_iv,m_salud_iv,m_urb_iv,m_trans_iv,m_soc_iv), function(m) sqrt(diag(vc(m))))
ses <- lapply(list(m_edu_iv,m_salud_iv,m_urb_iv,m_trans_iv,m_soc_iv), function(m) sqrt(diag(vc(m))))
#Presentación de resultados en tabla
stargazer(
m_edu_iv,m_salud_iv,m_trans_iv,m_soc_iv,
type = "text", se = ses,
dep.var.labels = c("Gasto Educación/Cultura","Gasto Salud/Saneamiento","Gasto Transporte","Gasto Asistencia Social/Transferencias"),
covariate.labels = c("Ingresos (IV)","Latitud","Longitud","Costa","Dist. capital federal","Dist. capital estatal","Capital estatal"),
omit = "factor\\(state\\)|\\(Intercept\\)", omit.labels = "Dummies de estado",
star.cutoffs = c(.10,.05,.01), digits = 3,
title = "Segunda etapa (IV): ingresos instrumentados y gastos por función",
notes = "Errores estándar robustos agrupados por estado entre paréntesis."
)
names(data_final)
sapply(data_final, label)
library(Hmisc)
sapply(data_final, function(x) attr(x, "label"))
# Eliminar NA
data_reducido <- na.omit(data_final[, c("perc_nofavelas",
"salon_pob_2005",
"revenue",
"oil_pc")])
# Revisar que se eliminaron los NA
sum(is.na(data_reducido$revenue))
# Personas que no viven en favelas en 2000
m_nofav <- lm(perc_nofavelas ~ oil_pc + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state_id), data = data_reducido)
View(data_reducido)
rm(data_reducido)
# Personas que no viven en favelas en 2000
m_nofav <- lm(perc_nofavelas ~ oil_pc + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state_id), data = data_final)
# Personas que no viven en favelas en 2000
m_nofav <- lm(perc_nofavelas ~ oil_pc + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state), data = data_final)
# Número de salones por millón de habitantes en el 2005.
m_classrooms <- lm(salon_pob_2005 ~ oil_pc + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state), data = data_final)
# Errores estándar robustos agrupados por estado
se_nofav      <- sqrt(diag(vcovCL(m_nofav, cluster = ~ state_id, type = "HC1")))
se_classrooms <- sqrt(diag(vcovCL(m_classrooms, cluster = ~ state_id, type = "HC1")))
# Errores estándar robustos agrupados por estado
se_nofav      <- sqrt(diag(vcovCL(m_nofav, cluster = ~ state, type = "HC1")))
se_classrooms <- sqrt(diag(vcovCL(m_classrooms, cluster = ~ state, type = "HC1")))
library(lmtest)
library(sandwich)
# Errores estándar robustos agrupados por estado
se_nofav      <- sqrt(diag(vcovCL(m_nofav, cluster = ~ state, type = "HC1")))
se_classrooms <- sqrt(diag(vcovCL(m_classrooms, cluster = ~ state, type = "HC1")))
#Tabulación forma reducida
stargazer(
m_nofav, m_classrooms,
type             = "text",
se               = list(se_nofav, se_classrooms),
dep.var.labels   = c("No-favelas", "Salones por millón de habitantes"),
covariate.labels = c("Producción de petróleo per cápita (instrumento)"),
keep             = "^oil_pc$",
omit             = "factor\\(state_id\\)|lat|lon|coast|dist_fedcap|dist_statecap|state_cap|Intercept",
omit.labels      = "Controles y efectos fijos",
star.cutoffs     = c(.10,.05,.01),
digits           = 3,
title            = "Forma reducida: efecto del petróleo sobre indicadores de bienestar",
notes            = "Errores estándar robustos agrupados por estado entre paréntesis. Modelos incluyen controles geográficos y efectos fijos de estado.",
notes.align      = "l"
)
library(stargazer)
#Tabulación forma reducida
stargazer(
m_nofav, m_classrooms,
type             = "text",
se               = list(se_nofav, se_classrooms),
dep.var.labels   = c("No-favelas", "Salones por millón de habitantes"),
covariate.labels = c("Producción de petróleo per cápita (instrumento)"),
keep             = "^oil_pc$",
omit             = "factor\\(state_id\\)|lat|lon|coast|dist_fedcap|dist_statecap|state_cap|Intercept",
omit.labels      = "Controles y efectos fijos",
star.cutoffs     = c(.10,.05,.01),
digits           = 3,
title            = "Forma reducida: efecto del petróleo sobre indicadores de bienestar",
notes            = "Errores estándar robustos agrupados por estado entre paréntesis. Modelos incluyen controles geográficos y efectos fijos de estado.",
notes.align      = "l"
)
#Tabulación forma reducida
stargazer(
m_nofav, m_classrooms,
type             = "html",
se               = list(se_nofav, se_classrooms),
dep.var.labels   = c("No-favelas", "Salones por millón de habitantes"),
covariate.labels = c("Producción de petróleo per cápita (instrumento)"),
keep             = "^oil_pc$",
omit             = "factor\\(state_id\\)|lat|lon|coast|dist_fedcap|dist_statecap|state_cap|Intercept",
omit.labels      = "Controles y efectos fijos",
star.cutoffs     = c(.10,.05,.01),
digits           = 3,
title            = "Forma reducida: efecto del petróleo sobre indicadores de bienestar",
notes            = "Errores estándar robustos agrupados por estado entre paréntesis. Modelos incluyen controles geográficos y efectos fijos de estado.",
notes.align      = "l"
)
