---
title: "Taller 2- Evaluación de impacto"
author: "Camila Caraballo, Laura Rivera"
date: "2025-09-2"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

# Taller 2- Variables Instrumentales

```{r}
# Cargar liberias y paquetes

#install.packages("haven") cual
#install.packages("plm")
#install.packages("skimr")
#install.packages("dplyr")
#install.packages("ggplot2")
#install.packages("modelsummary")


library(haven)
library(plm)
library(scales)
library(skimr)
library(dplyr)
library(ggplot2)
library(AER)        
library(fixest)
library(lmtest)
library(sandwich)
library(tidyverse)
library(stargazer)

# Leer archivo .dta
data <- read_dta("oil_windfall_sin10perc.dta")
set.seed(201613424)
```

### 1. Ecuaciones

##### Especificación en niveles (OLS, Ecuación 1)

$$W_{m}= δ_1​+θ_1​R_m​+X_mρ_1​+u_{m1}​$$

En este modelo, $W_m$ representa el conjunto de resultados económicos a
nivel de AMC que incluyen el gasto reportado en distintas partidas de
presupuesto a nivel municipal, provisión de bienes y servicios públicos,
transferencias, ingresos de los hogares y tasas de pobreza. A su vez,
$R_m$ corresponde a una medida de los ingresos municipales y es la
variable explicativa principal. Finalmente, $X_m$ reúne distintas
características geográficas de cada municipio, incluyendo su latitud y
longitud, si está ubicado en la costa, la distancia a las capitales
federal y estatal, un indicador de si es capital estatal, así como
efectos fijos por estado.

##### Especificación VI (OLS, Ecuación 3 y 4)

$$Y_{m,1970}=δ_3+η_0 Q_{m,2000}+X'_mρ_3+ w_{m3}$$

Donde $Y_{m,1970}$ es el resultado socioeconómico en AMC para el año
1970 y se usa como “placebo” para probar que el instrumento no estaba
correlacionado con condiciones socioeconómicas históricas, $Q_{m,2000}$
hace referencia a la producción petrolera en el año 2000 en el municipio
$m$, el cual funciona como el instrumento para regalías y $Xm′$ es el
vector de controles geográficos y estructurales como latitud, longitud,
si es costa, distancias a capitales, si es capital estatal junto con
efectos fijos estatales.

$$Y_{m,2002} = δ_4+η_4Q_{m,2002}+X'_mρ_4+w_{m4}$$

Donde $Y_{m,1970}$ es el Producto Interno Bruto en 2002 del municipio
$m$, $Q_{m,2000}$ es la producción petrolera en el año 2000 en el
municipio $m$. y $X'_m$ es el vector de controles geográficos y
estructurales.

### 2. Intuición metodológica

##### ¿Cuál es la intuición detrás de implementar Variables Instrumentales (VI) en vez de Mínimos Cuadrados Ordinarios (MCO)? En este escenario: Mencione al menos un sesgo del cual podríamos estar preocupados si interpretamos los efectos por MCO de manera causal. ¿Cuáles son los supuestos necesarios para que VI nos permita recuperar el efecto causal de interés? ¿Son creíbles los supuestos? Argumenten.

La razón principal para emplear el método de variable instrumental es
que una estimación por Mínimos Cuadrados Ordinarios (MCO) podría arrojar
resultados sesgados porque los ingresos municipales no son estrictamente
exógenos. Municipios con poblaciones de mayores ingresos o con mayor
capacidad institucional pueden mostrar al mismo tiempo mejores
indicadores socioeconómicos, lo cual impediría identificar un efecto
puramente causal. Existe también la posibilidad de causalidad inversa en
la medida en que condiciones socioeconómicas más favorables permiten
recaudar más ingresos fiscales. Además, no puede descartarse la
influencia de factores no observados, como la calidad de las
instituciones locales o la existencia de redes clientelares, que
expliquen simultáneamente mayores ingresos y peores resultados en la
provisión de bienes y servicios públicos.

Ante estos problemas los autores recurren a la producción de petróleo
como instrumento de los ingresos municipales. La variación geográfica en
la producción se interpreta como un shock exógeno que incrementa los
recursos locales mediante regalías y permite recuperar el efecto causal
de esos ingresos extraordinarios sobre el gasto público y los resultados
sociales.

La validez de esta estrategia depende del cumplimiento de dos
condiciones. La primera es la relevancia, que implica que la producción
de petróleo $Q_m$​ esté correlacionada con los ingresos municipales
$R_m$Los autores muestran evidencia a favor de este punto al encontrar
que un real adicional de producción petrolera se asocia con un
incremento promedio de tres centavos en los ingresos municipales. La
segunda es la exclusión, que exige que la producción de petróleo afecte
los resultados socioeconómicos $W_m$ únicamente a través de los ingresos
municipales. Este supuesto se sostiene en el hecho de que los campos
petroleros se ubican costa afuera, son operados por Petrobras y utilizan
insumos y mano de obra altamente especializados que no provienen de los
municipios beneficiarios, lo que reduce la posibilidad de un impacto
directo sobre la provisión de servicios, las transferencias o los
ingresos de los hogares.

La extracción de petróleo mar adentro limita de manera importante la
existencia de derrames productivos locales y evita que los municipios
reciban beneficios económicos distintos a las transferencias fiscales.
Además, como las regalías se asignan según reglas legales vinculadas a
la ubicación geográfica de los campos, el ingreso municipal depende de
criterios externos y no de la capacidad de gestión local. Para reforzar
este argumento, los autores presentan pruebas de falsificación que
muestran que las condiciones socioeconómicas en 1970, antes de los
descubrimientos offshore, no predicen la producción futura de petróleo.
Esto sugiere que la asignación de los yacimientos no está asociada a
características históricas de desarrollo municipal sino que se comporta
de manera aleatoria una vez se controlan los factores geográficos.

En síntesis, los autores defienden de forma convincente que la
localización costa afuera de los yacimientos impide la existencia de un
canal productivo directo entre la actividad petrolera y el bienestar
local, de modo que la única vía de transmisión entre la abundancia de
petróleo y los resultados municipales es el aumento de regalías y
transferencias fiscales.

### 3. Primera etapa

##### En una tabla, presenten los resultados de estimar la primera etapa de la metodología de Variables Instrumentales. ¿Es el instrumento relevante y fuerte? Contesten esta pregunta usando los dos criterios recomendados en la clase magistral.

```{r}

# Eliminar aleatoriamente el 10% de la base

# Número exacto de filas a eliminar (10% de la base)
eliminar <- round(0.1 * nrow(data))

# Escoger aleatoriamente los índices a eliminar
drop_index <- sample(1:nrow(data), size = eliminar)

# Crear la submuestra eliminando esos índices
data_final <- data[-drop_index, ]

# Solo municipios costeros que reciben petroleo 
data_final <- subset(data_final, coastal == 1 & onshore == 0)

# Observa base
str(data_final)

#Transformación de variables 
data_final <- data_final %>%
    rename(
    revenue     = mun_budget_revenue2000_pred_c,
    oil_pc      = oilandgasvalue2000_cap,
    lat         = latitude1998,
    lon         = longitude1998,
    coast       = coastal,
    dist_fedcap = dist_federal_capital1998,
    dist_statecap = dist_state_capital1998,
    state_cap   = state_capital,
    state    = sigla, 
    
  )
  
  
# Cambiar a tipo factor 
data_final <- data_final %>% mutate(state = as.factor(state))

# Primera etapa con FE de estado 
prim_et <- lm(
  revenue ~ oil_pc + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state),
  data = data_final
)

#Resultados por cluster
vc <- vcovCL(prim_et, cluster = ~ state, type = "HC1")
ct <- coeftest(prim_et, vcov = vc)

# Solo coeficientes a reportar y sus SE
vars_keep <- c("oil_pc","lat","lon","coast","dist_fedcap","dist_statecap","state_cap")
idx <- match(vars_keep, rownames(ct))
betas <- ct[idx, "Estimate"]
ses   <- ct[idx, "Std. Error"]

#Tabulación de los resultados 
stargazer(
  prim_et,
  type = "text",                    
  coef = list(betas),
  se   = list(ses),
  keep = paste0("^(", paste(vars_keep, collapse="|"), ")$"),
  dep.var.labels   = "Ingresos municipales",
  covariate.labels = c("Producción de petróleo","Latitud","Longitud",
                       "Dummy costa","Dist. capital federal","Dist. capital estatal","Dummy capital estatal"),
  omit             = "factor\\(state_id\\)|\\(Intercept\\)",
  star.cutoffs     = c(.10,.05,.01),
  digits           = 3,
  title            = "Primera etapa: ingresos municipales sobre producción petrolera y controles"
)

```

Los resultados de esta primera etapa muestran que la producción de
petróleo es un instrumento relevante para explicar los ingresos
municipales pues la relación entre estas variables es estadísticamente
significativo incluso al controlar por factores geográficos. Dado que se
presenta un estadístico F de 10,9, el cual super el umbral de 10
recomendado, implica que el instrumento es lo suficientemente relevante.
Este coeficiente estimado implica que por cada real per cápita adicional
de producción petrolera, los municipios reciben en promedio 3,5 centavos
de ingresos. Este resultado coincide con los hallazgos del artículo de
investigación que interpretan la variacióon de la producción de petróleo
offshore como un choque exógeno que incrementa los ingresos municipales
a través de las regalías, reforzando la argumentación de su estrategia
de identificación.

### 4. Segunda etapa

##### En una tabla, presenten e interpreten los resultados de estimar por VI el efecto de (mayores) ingresos públicos (producto del petróleo) sobre el gasto público reportado en el año 2000 en Educación y Cultura, Salud y Sanitización, Transporte y Transferencias Sociales.

```{r}

data_final <- data_final %>%
    rename(
    amc_code        = new_code_1970_1997,
    per_ho_elec     = prc_hhld_with_power_2000,
    salon_pob_2005  = clroomsMunicipal_pop2005,
    clinic_pob_2002 = estab_mun2002_without_pop,
    km_pob_2005     = km_paved_munic_c,
    ex_edu_cult        = pmun_exp_funct_educ_cult2000c,
    ex_salud_sani      = pmun_exp_funct_health_sanit2000c,
    ex_desarrollo_urb  = pmun_exp_funct_hous_urban2000c, 
    ex_transp          = pmun_exp_funct_transport2000c,
    ex_soc_transf      = pmun_exp_funct_welf2000c,
    perc_nofavelas     = p_hhld_abovestrandard_ppl_2000
    
  )
#Agrupación de variables de interés
outcomes <- c(
  "ex_edu_cult", 
  "ex_salud_sani", 
  "ex_desarrollo_urb", 
  "ex_transp", "
  ex_soc_transf"
)

data_final$state <- as.factor(data_final$state)

#Estimación de la segunda etapa para cada una de las variables de resultado 

m_edu_iv <- ivreg(ex_edu_cult ~ revenue + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state) | oil_pc + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state), data = data_final)

m_salud_iv <- ivreg(ex_salud_sani ~ revenue + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state) |oil_pc + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state), data = data_final)

m_urb_iv  <- ivreg(ex_desarrollo_urb ~ revenue + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state) |oil_pc + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state), data = data_final)

m_trans_iv <- ivreg(ex_transp ~ revenue + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state) |oil_pc + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state), data = data_final)

m_soc_iv   <- ivreg(ex_soc_transf     ~ revenue + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state) |oil_pc + lat + lon + coast + dist_fedcap + dist_statecap + state_cap + factor(state), data = data_final)

#Errores agrupados por Estado 
vc <- function(m) sandwich::vcovCL(m, cluster = ~ state, type = "HC1")
ses <- lapply(list(m_edu_iv,m_salud_iv,m_urb_iv,m_trans_iv,m_soc_iv), function(m) sqrt(diag(vc(m))))

#Presentación de resultados en tabla
stargazer(
  m_edu_iv,m_salud_iv,m_trans_iv,m_soc_iv,
  type = "text", se = ses,
  dep.var.labels = c("Gasto Educación/Cultura","Gasto Salud/Saneamiento","Gasto Transporte","Gasto Asistencia Social"),
  covariate.labels = c("Ingresos (IV)","Latitud","Longitud","Costa","Dist. capital federal","Dist. capital estatal","Capital estatal"),
  omit = "factor\\(state\\)|\\(Intercept\\)", omit.labels = "Dummies de estado",
  star.cutoffs = c(.10,.05,.01), digits = 3,
  title = "Segunda etapa (IV): ingresos instrumentados y gastos por función",
  notes = "Errores estándar robustos agrupados por estado entre paréntesis."
)


```

Análisis: Los resultados de la estimación por variables instrumentales
muestran que un aumento en los ingresos municipales predichos por la
producción de petróleo/gas se traduce en mayores niveles de gasto
público municipal en todos los sectores analizados en el año 2000.

1)  Educación y Cultura: el coeficiente es 0.139, lo que indica que un
    aumento de 1 unidad en los ingresos municipales predichos se asocia
    con un incremento de 0.14 unidades en el gasto en Educación y
    Cultura. Este efecto es estadísticamente significativo al 1%, lo que
    demuestra un impacto claro y positivo.

2)  Salud y Sanitización: el coeficiente es 0.109\*, también altamente
    significativo, mostrando que mayores ingresos municipales impulsan
    el gasto en servicios de salud y saneamiento de manera similar.

3)  Transporte: el coeficiente es 0.123, significativo al 1%, indicando
    que el gasto en infraestructura y transporte aumenta con mayores
    ingresos públicos derivados del petróleo.

4)  Transferencias Sociales: el coeficiente es 0.052\*, positivo y
    significativo, aunque menor que en los otros sectores, lo que
    sugiere que una parte de los recursos se destina a programas de
    bienestar social, pero en menor proporción comparado con Educación,
    Salud y Transporte.

Finalmente, estos resultados muestran que los choques positivos de
ingresos provenientes del petróleo genera un aumento del gasto público
municipal en múltiples sectores, con mayor intensidad en Educación,
Salud y Transporte, y menor en Transferencias Sociales. Esto indica que
los municipios costeros que reciben petróleo offshore tienden a
canalizar estos recursos hacia servicios públicos esenciales.

### 5. Forma reducida

##### En una tabla, presenten e interpreten los resultados de estimar por VI el efecto de (mayores) ingresos públicos (producto del petróleo) sobre las variables efectivas de bienestar. En particular, sobre proporción de personas que no viven en favelas en 2000 y el número de salones por millón de habitantes en el 2005. ¿Qué indican sus resultados? ¿Mayores ingresos públicos resultan en niveles del bienestar medido a través de estas variables?. En texto describa los resultados para la primera variable .

```{r}
# Eliminar NA
data_reducido <- na.omit(data_final[, c("p_hhld_abovestrandard_ppl_2000",
                             "clroomsMunicipal_pop2005",
                             "mun_budget_revenue2000_pred_c",
                             "oilandgasvalue2000_cap")])

# Revisar que se eliminaron los NA
sum(is.na(data_reducido$revenue))

# Personas que no viven en favelas en 2000
favelas <- lm(p_hhld_abovestrandard_ppl_2000 ~ oilandgasvalue2000_cap, data = data3)

# Número de salones por millón de habitantes en el 2005.
salones <- lm(clroomsMunicipal_pop2005 ~ oilandgasvalue2000_cap, data = data3)

# Tabla
stargazer(favelas, salones,
          type = "text",
          dep.var.labels = c("% población fuera de favelas (2000)",
                             "Salones por millón de habitantes (2005)"),
          covariate.labels = c("Ingresos municipales (IV)"),
          column.labels = c("Bienestar 1", "Bienestar 2"),
          star.cutoffs = c(0.1, 0.05, 0.01),
          notes = "Errores estándar robustos entre paréntesis. *** p<0.01, ** p<0.05, * p<0.1",
          notes.align = "l")
```

Anaálisis: Los resultados de la estimación de forma reducida muestran
que los ingresos municipales predichos por la producción de petróleo no
generan mejoras evidentes en el bienestar medido a través de la
proporción de población que no vive en favelas en 2000. El coeficiente
del ingreso municipal es negativo y muy pequeño (-0.0005) y
estadísticamente significativo, lo que indica que un aumento en los
ingresos derivados del petróleo/gas se asocia con una ligera disminución
de esta proporción. Aunque el instrumento utilizado es fuerte (F
estadístico = 23.28\*\*\*), el modelo explica solo el 13.6% de la
variabilidad en la variable de bienestar, sugiriendo que otros factores
locales son determinantes más importantes. En conclusión, estos
resultados sugieren que mayores ingresos públicos no se traducen
necesariamente en mejoras efectivas en la calidad de vida medida por
este indicador en el año 2000.
